{% extends 'index.html' %}
{% block title %}Profile{% endblock title %}

{% block styles %}
.tab-container {
  max-width: 960px;
  margin: 20px auto;
  background-color: #1e1e2f;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
  border-radius: 12px;
  overflow: hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Tab Header */
.tab-header {
  display: flex;
  justify-content: center;
  background-color: #00cc66;
  padding: 10px;
}

.tab-link {
  padding: 12px 24px;
  margin: 0 10px;
  font-weight: bold;
  color: white;
  background: none;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  transition: background-color 0.3s;
}

.tab-link.active {
  background-color: #00a653;
  color: #fff;
}

/* Tab Content */
.tab-content {
  display: none;
  height: 500px; /* Set your preferred height */
  overflow-y: auto; /* Scroll only inside tab content */
  padding: 24px;
  background-color: #2a2a40;
  color: #f0f0f0;
}

.tab-content h2 {
  font-size: 24px;
  margin-bottom: 20px;
}

/* Event Box (Consistent with Dashboard) */
.event-box {
  position: relative;
  background-color: #2a2a40;
  border-radius: 12px;
  box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
  cursor: pointer;
  color: #fff;
  border-left: 4px solid #00cc99;
  margin-bottom: 20px;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.event-box:hover {
  transform: scale(1.03);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
  background-image: linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('https://cdn.mos.cms.futurecdn.net/cRFFW6JNXqEtkBA3P2U68m.jpg');
  border-left: 4px solid #00ffcc;
}

.event-box:hover .event-details {
  background-color: rgba(0, 0, 0, 0.5);
}

/* Event Details */
.event-details {
  padding: 20px;
  transition: background-color 0.3s, color 0.3s;
}

/* Title and Info */
.event-title {
  font-size: 20px;
  font-weight: 600;
  color: #00ffcc;
  margin-bottom: 12px;
}

.event-info span {
  display: block;
  font-size: 14px;
  color: #b0b0b0;
  margin-bottom: 4px;
}

/* Match Status */
.event-status {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 2;
}

.event-match-status {
  display: inline-block;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
  background-color: #444;
  border: 1px solid #666;
  color: white;
}

.event-matched {
  background-color: #4caf50;
  border-color: #81c784;
}

.event-unmatched {
  background-color: #ff4081;
  border-color: #ff79a8;
}

.no-matches {
  text-align: center;
  color: #ccc;
  margin-top: 30px;
}

.transaction-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  background-color: #2a2a40;
  color: #ffffff;
  margin-top: 10px;
  border-radius: 8px;
  overflow: hidden;
}

.transaction-table th,
.transaction-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid #3a3a4d;
}

.transaction-table th {
  background-color: #1e1e2f;
  color: #00ffcc;
  font-weight: bold;
  position: sticky;
  top: 0;
  z-index: 1;
}

.transaction-credit {
  color: #4caf50;
  font-weight: bold;
}

.transaction-debit {
  color: #f44336;
  font-weight: bold;
}

.transaction-empty {
  text-align: center;
  padding: 20px;
  color: #aaa;
}

/* Search & Sort Controls */
.txn-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  gap: 10px;
}

.txn-search,
.txn-sort {
  padding: 8px 12px 8px;
  border: 1px solid #00ffcc;
  border-radius: 6px;
  background-color: #1e1e2f;
  color: #ffffff;
  font-size: 14px;
  outline: none;
  transition: border-color 0.3s ease, background-color 0.3s ease;
}

.txn-search:focus,
.txn-sort:focus {
  border-color: #00cc99;
  background-color: #25253a;
}

.txn-search::placeholder {
  color: #999;
}

.txn-sort {
  cursor: pointer;
}

.txn-sort option {
  background-color: #1e1e2f;
  color: #ffffff;
}


{% endblock styles %}

{% block body %}
<div class="tab-container">
  <div class="tab-header">
    <button class="tab-link active" onclick="openTab(event, 'upcoming')">Upcoming Matches</button>
    <button class="tab-link" onclick="openTab(event, 'completed')">Completed Matches</button>
    <button class="tab-link" onclick="openTab(event, 'transactions')">Transactions</button>

  </div>

  <div id="upcoming" class="tab-content" style="display: block;">
    <h2>Upcoming Matches</h2>
    <div id="upcoming-events-container">
      <p class="no-matches">Loading...</p>
    </div>
  </div>

  <div id="completed" class="tab-content">
    <h2>Completed Matches</h2>
    <div id="completed-events-container">
      <p class="no-matches">Loading...</p>
    </div>
  </div>

<div class="txn-controls">
  <input type="text" id="txn-search" class="txn-search" placeholder="Search transactions..." oninput="applyTxnFilters()">
  <select id="txn-sort" class="txn-sort" onchange="applyTxnFilters()">
    <option value="-timestamp">Newest First</option>
    <option value="timestamp">Oldest First</option>
    <option value="-amount">Amount (High → Low)</option>
    <option value="amount">Amount (Low → High)</option>
  </select>
</div>


  <div id="transactions" class="tab-content">
  <h2>Transaction History</h2>
  <div id="transactions-container">
    <p class="no-matches">Loading...</p>
  </div>
</div>
</div>



{% endblock body %}

{% block scripts %}
<script>
const userId = {{ user.id }};

function openTab(event, tabName) {
  const tabContents = document.getElementsByClassName("tab-content");
  const tabLinks = document.getElementsByClassName("tab-link");

  Array.from(tabContents).forEach(tab => tab.style.display = "none");
  Array.from(tabLinks).forEach(link => link.classList.remove("active"));

  document.getElementById(tabName).style.display = "block";
  event.currentTarget.classList.add("active");
}

function renderEvents(events, containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  if (!events.length) {
    container.innerHTML = `<p class="no-matches">No matches found.</p>`;
    return;
  }

  for (const event of events) {
    const statusClass = event.is_match ? "event-matched" : "event-unmatched";
    const statusText = event.is_completed
      ? "Completed"
      : (event.is_match ? "Ready for Battle" : "Waiting for Opponents");

    container.innerHTML += `
      <a href="/event/${event.id}/" style="text-decoration: none; color: inherit;">
        <div class="event-box">
          <div class="event-details">
            <div class="event-status">
              <span class="event-match-status ${statusClass}">
                ${statusText}
              </span>
            </div>
            <div class="event-title">${event.game_name}</div>
            <div class="event-info">
              <span>Event ID: ${event.id}</span>
              <span>Created by: ${event.user.username}</span>
              <span>Match type: ${event.match_type}</span>
              <span>Amount: ₹${event.amount}</span>
            </div>
          </div>
        </div>
      </a>`;
  }
}


function fetchTransactions(search = '', sort = '-timestamp') {
  const url = `/api/users/${userId}/transactions/?search=${encodeURIComponent(search)}&ordering=${encodeURIComponent(sort)}`;

  fetch(url)
    .then(res => res.json())
    .then(data => renderTransactions(data))
    .catch(err => {
      console.error("Error loading transactions:", err);
      document.getElementById("transactions-container").innerHTML =
        "<p class='no-matches'>Failed to load transactions.</p>";
    });
}


function renderTransactions(transactions) {
  const container = document.getElementById("transactions-container");
  container.innerHTML = "";

  if (!transactions.length) {
    container.innerHTML = "<p class='transaction-empty'>No transactions found.</p>";
    return;
  }

  const table = document.createElement("table");
  table.className = "transaction-table";

  table.innerHTML = `
    <thead>
      <tr>
        <th>Type</th>
        <th>Amount</th>
        <th>Description</th>
        <th>Date & Time</th>
      </tr>
    </thead>
    <tbody>
      ${transactions.map(txn => `
        <tr>
          <td class="${txn.type === "credit" ? "transaction-credit" : "transaction-debit"}">
            ${txn.type.charAt(0).toUpperCase() + txn.type.slice(1)}
          </td>
          <td>₹${parseFloat(txn.amount).toFixed(2)}</td>
          <td>${txn.description}</td>
          <td>${new Date(txn.timestamp).toLocaleString()}</td>
        </tr>
      `).join('')}
    </tbody>
  `;

  container.appendChild(table);
}



function fetchMatches() {
  fetch(`/api/users/${userId}/events/upcoming/`)
    .then(res => res.json())
    .then(data => renderEvents(data, "upcoming-events-container"))
    .catch(err => {
      console.error("Error loading upcoming events:", err);
      document.getElementById("upcoming-events-container").innerHTML =
        "<p class='no-matches'>Failed to load upcoming events.</p>";
    });

  fetch(`/api/users/${userId}/events/completed/`)
    .then(res => res.json())
    .then(data => renderEvents(data, "completed-events-container"))
    .catch(err => {
      console.error("Error loading completed events:", err);
      document.getElementById("completed-events-container").innerHTML =
        "<p class='no-matches'>Failed to load completed events.</p>";
    });

  fetch(`/api/users/${userId}/transactions/`)
    .then(res => res.json())
    .then(data => renderTransactions(data))
    .catch(err => {
      console.error("Error loading transactions:", err);
      document.getElementById("transactions-container").innerHTML =
        "<p class='no-matches'>Failed to load transactions.</p>";
    });
}

function applyTxnFilters() {
  const search = document.getElementById("txn-search").value;
  const sort = document.getElementById("txn-sort").value;
  fetchTransactions(search, sort);
}

document.addEventListener("DOMContentLoaded", () => {
  fetchMatches();
  fetchTransactions(); // loads default search/sort
});

</script>

{% endblock scripts %}