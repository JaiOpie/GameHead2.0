{% extends 'index.html' %}
{% block title %}Event Details{% endblock title %}
{% load static %}


{% block styles %}
@import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap');

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #1e1e2f;
    color: #ffffff;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 600px;
    margin: 50px auto;
    background-color: #2a2a40;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
    position: relative;
}

h2 {
    color: #00ffcc;
    text-align: center;
    margin-bottom: 24px;
}

.field-group {
    margin-bottom: 18px;
    display: flex;
    flex-direction: column;
}

.field-group label {
    font-weight: bold;
    color: #cccccc;
    margin-bottom: 6px;
    font-size: 14px;
}

.field-group span {
    color: #ffffff;
    font-size: 15px;
}

input[type="text"] {
    width: 100%;
    padding: 12px;
    border: 1px solid #555555;
    border-radius: 8px;
    background-color: #1e1e2f;
    color: #ffffff;
    font-size: 14px;
    box-sizing: border-box;
    box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.5);
    margin-top: 6px;
}

input[type="text"]:focus {
    outline: none;
    border-color: #00cc99;
}

button {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
}

button[type="submit"] {
    background-color: #00cc66;
    color: #ffffff;
    margin-top: 10px;
}

button[type="submit"]:hover {
    background-color: #00a653;
}

button.match-button {
    background-color: #f44336;
    width: 100%;
    margin-top: 20px;
}

button.match-button:hover {
    background-color: #c62828;
}

button.complete-button {
    background-color: #2196f3;
    width: 100%;
    margin-top: 20px;
}

button.complete-button:hover {
    background-color: #1976d2;
}

.popup-form {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #2a2a40;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.7);
    z-index: 9999;
    width: 90%;
    max-width: 400px;
}

.popup-form h2 {
    margin-top: 0;
    color: #00ffcc;
    text-align: center;
    margin-bottom: 20px;
}

.popup-form input[type="text"] {
    margin-top: 10px;
}

.popup-form button {
    width: 100%;
    margin-top: 10px;
}

.status-label, .match-type-label {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 5px;
    font-size: 13px;
    font-weight: bold;
}

.status-active {
    background-color: #4caf50;
}

.status-inactive {
    background-color: #f44336;
}

.match-solo {
    background-color: #2196f3;
}

.match-duo {
    background-color: #ff9800;
}

.match-squad {
    background-color: #9c27b0;
}

.user-label {
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
}

.game-logo {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid #00cc99;
}

.user-ingame-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.user1-in-game-label, .user2-in-game-label {
    padding: 6px 12px;
    background-color: rgba(0, 0, 0, 0.6);
    border-radius: 8px;
    font-weight: bold;
    color: #00ffcc;
    font-size: 14px;
}

.event-details-table {
    width: 100%;
    border-collapse: collapse;
}

.event-details-table th {
    text-align: left;
    color: #cccccc;
    padding: 10px 0;
    vertical-align: top;
    width: 30%;
}

.event-details-table td {
    padding: 10px 0;
    color: #ffffff;
}

.notification {
    padding: 12px 20px;
    margin-bottom: 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
}

.notification.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.notification.warning,
.notification.error {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
}

.popup-warning-box {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeeba;
  padding: 10px 16px;
  border-radius: 6px;
  font-size: 14px;
  width: 90%;
  max-width: 360px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  z-index: 10000;
}

.popup-warning-box .close-btn {
  position: absolute;
  top: 5px;
  right: 10px;
  font-size: 18px;
  cursor: pointer;
}



{% endblock styles %}

{% block body %}
<div class="container">
  <div id="matchPopupWarning" class="popup-warning-box" style="display: none;">
  <span class="close-btn" onclick="closePopupWarning('matchPopupWarning')">&times;</span>
  <span id="matchPopupWarningText"></span>
</div>
  <div class="user-ingame-labels">
    <span class="user1-in-game-label">
      {{ event.user1ingame|capfirst }}
      {% if event.is_completed and match.winner.id == match.user1.id %}
        <img src="{% static 'winner.png' %}" alt="Winner" style="width: 18px; height: 18px; margin-left: 6px;">
      {% endif %}
    </span>
    <span class="user2-in-game-label">
      {% if event.user2ingame %}
        {{ event.user2ingame|capfirst }}
        {% if event.is_completed and match.winner.id == match.user2.id %}
          <img src="{% static 'winner.png' %}" alt="Winner" style="width: 18px; height: 18px; margin-left: 6px;">
        {% endif %}
      {% else %} Yet to be matched {% endif %}
    </span>
  </div>

  <form onsubmit="event.preventDefault(); saveRoomId({{ event.id }});">
    {% csrf_token %}
    <table class="event-details-table">
      <tr>
        <th>Game:</th>
        <td>
<img class="game-logo" src="{% static event.game.image %}" alt="{{ event.game.name }}">

        </td>
      </tr>
      <tr>
        <th>Match Type:</th>
        <td><span class="match-type-label match-{{ event.match_type|lower }}">{{ event.match_type|upper }}</span></td>
      </tr>
      <tr>
        <th>Amount:</th>
        <td>Rs.{{ event.amount }}</td>
      </tr>
      <tr>
        <th>Created by:</th>
        <td>{{ event.user|capfirst }}</td>
      </tr>
      {% if event.user.id == request.user.id %}
      <tr>
        <th>Room ID:</th>
        <td>
          <span id="roomIdDisplay">{{ event.room_id|default:"Not assigned yet" }}</span>
          <input type="text" id="roomIdInput" name="new_room_id" value="{{ event.room_id }}" style="display:none;" required>
          <img src="{% static 'edit.png' %}" alt="Edit" id="editRoomIdIcon" onclick="enableRoomIdEdit()" style="cursor:pointer; width: 20px; height: 20px;">
          <button type="submit" id="submitRoomIdBtn" style="display:none;">Save</button>
        </td>
      </tr>
      {% endif %}
    </table>
  </form>

  {% if not event.is_match and event.user.id != request.user.id %}
  <button class="match-button" onclick="openForm()">Tap here to match</button>
  {% endif %}

  {% if event.is_match and not event.is_completed and event.user.id == request.user.id %}
  <button class="complete-button" onclick="openCompletePopup()">Complete Event</button>
  {% endif %}

  {% if event.user.id == request.user.id and not event.is_completed %}
  <button class="match-button" style="background-color: #ff1744;" onclick="openDeletePopup()">Delete Event</button>
  {% endif %}
</div>

<!-- Match Event Popup -->
<div class="popup-form" id="popupForm">
  <div id="popupWarning" class="popup-warning" style="display:none;"></div>
  <h2>Enter In-Game Name</h2>
  <form onsubmit="event.preventDefault(); matchEvent({{ event.id }});">
    {% csrf_token %}
    <div class="field-group">
      <label>In-Game Name:</label>
      <input type="text" name="ingame_name" placeholder="Enter your in-game name" required>
    </div>
    <button type="submit">Submit</button>
    <button type="button" onclick="closeForm()">Cancel</button>
  </form>
</div>

<!-- Complete Event Popup -->
<div class="popup-form" id="completePopup">
  <div id="popupWarning" class="popup-warning" style="display:none;"></div>
  <h2>Complete Event</h2>
  <form onsubmit="event.preventDefault(); completeEventAPI({{ event.id }});">
    {% csrf_token %}
    <div class="field-group">
      <label>Select Winner:</label>
      <select name="winner_id" required>
        {% if user1 %}
        <option value="{{ user1.id }}">{{ user1.username|capfirst }}</option>
        {% endif %}
        {% if user2 %}
        <option value="{{ user2.id }}">{{ user2.username|capfirst }}</option>
        {% endif %}
      </select>
    </div>
    <button type="submit">Submit</button>
    <button type="button" onclick="closeCompletePopup()">Cancel</button>
  </form>
</div>

<!-- Delete Confirmation Popup -->
<div class="popup-form" id="deletePopup">
  <div id="popupWarning" class="popup-warning" style="display:none;"></div>
  <h2>Delete Event</h2>
  <p style="text-align:center; margin-bottom: 20px;">Are you sure you want to delete this event?</p>
  <form onsubmit="event.preventDefault(); deleteEvent({{ event.id }});">
    {% csrf_token %}
    <button type="submit" style="background-color: #ff1744;">Yes, Delete</button>
    <button type="button" onclick="closeDeletePopup()">Cancel</button>
  </form>
</div>
{% endblock body %}

{% block scripts %}
<script>

function getCSRFToken() {
  return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
}

function enableRoomIdEdit() {
  document.getElementById("roomIdDisplay").style.display = "none";
  document.getElementById("roomIdInput").style.display = "inline-block";
  document.getElementById("submitRoomIdBtn").style.display = "inline-block";
}

function saveRoomId(eventId) {
  const newRoomId = document.getElementById("roomIdInput").value;
  fetch(`/api/events/${eventId}/`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({ room_id: newRoomId }),
    credentials: "include"
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("roomIdDisplay").textContent = newRoomId;
    document.getElementById("roomIdDisplay").style.display = "inline-block";
    document.getElementById("roomIdInput").style.display = "none";
    document.getElementById("submitRoomIdBtn").style.display = "none";
    showPopupWarning("Room ID updated!");
  })
  .catch(err => console.error("Failed to update Room ID:", err));
}

function openForm() {
  document.getElementById("popupForm").style.display = "block";
  const warningBox = document.getElementById("popupWarning");
  if (warningBox) warningBox.style.display = "none";
}

function closeForm() {
  document.getElementById("popupForm").style.display = "none";
}

function openCompletePopup() {
  document.getElementById("completePopup").style.display = "block";
}

function closeCompletePopup() {
  document.getElementById("completePopup").style.display = "none";
}

function openDeletePopup() {
  document.getElementById("deletePopup").style.display = "block";
}

function closeDeletePopup() {
  document.getElementById("deletePopup").style.display = "none";
}


async function matchEvent(eventId) {
  const ingameName = document.querySelector('#popupForm input[name="ingame_name"]').value;

  const errorMsg = "Insufficient wallet balance to join this event.";

  try {
    // 1. Get wallet balance
    const balanceRes = await fetch("/api/wallet/balance", {
      method: "GET",
      headers: { "Accept": "application/json" },
      credentials: "include"
    });

    if (!balanceRes.ok) throw new Error("Failed to fetch wallet");

    const balanceData = await balanceRes.json();
    const walletBalance = parseFloat(balanceData.balance);
    const eventAmount = parseFloat({{ event.amount|floatformat:2 }}); // event.amount from Django context

    // 2. Compare with event's required amount
    if (walletBalance < eventAmount) {

      showPopupWarning(errorMsg);

      return;
    }

    // 3. Proceed to match
    const res = await fetch(`/api/event/${eventId}/join/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify({ ingame_name: ingameName }),
      credentials: "include"
    });

    if (res.ok) {
      showPopupWarning("Matched successfully!");
      window.location.reload();
    } else {
      const data = await res.json();
      showPopupWarning(data.detail || "Failed to match event.");
    }
  } catch (err) {
    showPopupWarning("Something went wrong while matching: " + err.message);
  }
}

function showPopupWarning(message, elementId = "matchPopupWarning") {
  const box = document.getElementById(elementId);
  const text = document.getElementById(`${elementId}Text`);
  if (box && text) {
    text.textContent = message;
    box.style.display = "block";

    setTimeout(() => {
      box.style.display = "none";
    }, 3000);
  }
}

function closePopupWarning(elementId) {
  const box = document.getElementById(elementId);
  if (box) box.style.display = "none";
}




function completeEventAPI(eventId) {
  const winnerId = document.querySelector('#completePopup select[name="winner_id"]').value;

  fetch(`/api/event/${eventId}/complete/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCSRFToken()
    },
    body: JSON.stringify({ winner_id: winnerId }),
    credentials: "include"
  })
  .then(res => res.json())
  .then(data => {
    showPopupWarning("Event marked as complete.");
    window.location.reload();
  })
  .catch(err => alert("Failed to complete event."));
}

function deleteEvent(eventId) {
  fetch(`/api/events/${eventId}/`, {
    method: "DELETE",
    headers: {
      "X-CSRFToken": getCSRFToken()
    },
    credentials: "include"
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to delete event.");
    showPopupWarning("Event deleted.");
    window.location.href = "/dashboard";
  })
  .catch(err => alert(err.message));
}
</script>
{% endblock scripts %}